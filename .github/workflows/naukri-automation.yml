name: Naukri Automation

on:
  workflow_dispatch:     # manual trigger (for testing)
  schedule:
    # 9:00 AM IST = 3:30 AM UTC
    - cron: "30 3 * * *"
  push:
    paths:
      - "resume.pdf"

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare runtime files
        run: |
          mkdir -p logs
          touch cookies.json

      - name: Start containers
        env:
          NAUKRI_EMAIL: ${{ secrets.NAUKRI_EMAIL }}
          NAUKRI_PASSWORD: ${{ secrets.NAUKRI_PASSWORD }}
          NAUKRI_PROFILE_URL: ${{ vars.NAUKRI_PROFILE_URL }}
          GITHUB_RESUME_URL: ${{ vars.RESUME_URL }}
        run: |
          docker compose up --build -d

          echo "Waiting for Selenium to be ready..."
          max_attempts=12
          attempt=0
          while [ $attempt -lt $max_attempts ]; do
            if curl -sf http://localhost:4444/wd/hub/status > /dev/null 2>&1; then
              echo "Selenium is ready!"
              exit 0
            fi
            attempt=$((attempt + 1))
            echo "Waiting for Selenium... (attempt $attempt/$max_attempts)"
            sleep 5
          done
          echo "Selenium did not become ready in time"
          exit 1

      - name: Run automation
        env:
          NAUKRI_EMAIL: ${{ secrets.NAUKRI_EMAIL }}
          NAUKRI_PASSWORD: ${{ secrets.NAUKRI_PASSWORD }}
          NAUKRI_PROFILE_URL: ${{ vars.NAUKRI_PROFILE_URL }}
          GITHUB_RESUME_URL: ${{ vars.RESUME_URL }}
        run: docker compose exec -T app python app/main.py

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: naukri-automation-logs
          path: logs/

      - name: Shutdown containers
        if: always()
        run: docker compose down
